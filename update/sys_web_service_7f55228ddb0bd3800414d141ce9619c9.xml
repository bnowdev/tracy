<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_web_service">
    <sys_web_service action="INSERT_OR_UPDATE">
        <active>true</active>
        <function_name>execute</function_name>
        <name>deployUpdateSet</name>
        <scoped_name>x_trz_deployUpdateSet</scoped_name>
        <script><![CDATA[(function scriptedWebServiceOperation(request, response) {
	
	response.result = 'wrongplatform';
	response.report = '';
	
	if(gs.getProperty('sdlc.test') == gs.getProperty('instance_name')) {
		// Good we are test platform
		response.result = 'missing';
		response.report = '';
		
		// Get completed update set from all sources that are active
		var gr = new GlideRecord('sys_update_set_source');
		gr.get('active', true);

		var myworker = new GlideUpdateSetWorker();
		myworker.setUpdateSourceSysId(gr.sys_id); // ID of update server
		myworker.setBackground(true);
		myworker.start();
		var progressId = myworker.progressID;
		
		// Wait for a while
		var progress = GlideRecord('sys_progress_worker');
		for(var i = 0; i < 100000; i++) {
			progress.get(progressId);
			if(progress.state == 'complete') {
				break;
			}
		}
	
		// Now find the update we are looking for
		var remote_updateset = new GlideRecord('sys_remote_update_set');
		remote_updateset.addQuery('remote_sys_id', request.sys_id);
		remote_updateset.query();
		remote_updateset.next();

		response.result = remote_updateset.sys_id;
	
		if(!remote_updateset.sys_id.nil()) {
			
			// Mark as previed - see PreviewAjax...
			remote_updateset.state = "previewed";
			remote_updateset.update();
			
			// Let make sure the reply has some data
			response.result = 'previewed';
			response.report = gs.getProperty('glide.servlet.uri') + remote_updateset.getLink();
			
			// Well we don't nee a worker
			var t = new UpdateSetPreviewer();
			
			// Lets make this rerun safe
			t.removePreviewRecords(remote_updateset.sys_id);
			t.generatePreviewRecords(remote_updateset.sys_id);
			
			// If all is fine commit
			if(!GlidePreviewProblemHandler.hasUnresolvedProblems(remote_updateset.sys_id)) {
				var lus = new GlideRecord('sys_update_set');
				var worker = new GlideUpdateSetWorker();
				var lsysid = worker.remoteUpdateSetCommit(lus, remote_updateset, remote_updateset.update_source.url);
				var rsysid = remote_updateset.sys_id;
				
				// great success
				response.result = 'commited';
				
				// Copy XML - done by hand in the ScriptInclude so we copy this
				var xgr = new GlideRecord("sys_update_xml");
				xgr.addQuery("remote_update_set", remote_updateset.sys_id);
				xgr.query();
				while(xgr.next()) {
					var lxgr = new GlideRecord("sys_update_xml");
					lxgr.initialize();
					lxgr.name = xgr.name;
					lxgr.payload = xgr.payload;
					lxgr.action = xgr.action;
					lxgr.type = xgr.type;
					lxgr.target_name = xgr.target_name;
					lxgr.view = xgr.view;
					lxgr.update_domain = xgr.update_domain;
					lxgr.table = xgr.table;
					lxgr.category = xgr.category;
					lxgr.application = xgr.application;
					lxgr.update_set = lsysid;
					if (lxgr.isValidField('replace_on_upgrade'))
						lxgr.replace_on_upgrade = xgr.replace_on_upgrade;
					lxgr.insert();
				}
				
				remote_updateset.update();
				
				// Seems odd to send information back to the worker that it provided... but why not.
				worker.setUpdateSetSysId(lsysid);
				worker.setBackground(false);
				worker.start();
			}
		}
	}
})(request, response);]]></script>
        <short_description/>
        <sys_class_name>sys_web_service</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-06-30 16:10:20</sys_created_on>
        <sys_id>7f55228ddb0bd3800414d141ce9619c9</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>deployUpdateSet</sys_name>
        <sys_package display_value="Tracy" source="x_trz">32de8034db031300147adec0cf96190a</sys_package>
        <sys_policy/>
        <sys_scope display_value="Tracy">32de8034db031300147adec0cf96190a</sys_scope>
        <sys_update_name>sys_web_service_7f55228ddb0bd3800414d141ce9619c9</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-06-30 16:10:20</sys_updated_on>
        <wsdl>https://businessnowsvsdemo11.service-now.com/x_trz_deployUpdateSet.do?WSDL</wsdl>
        <wsdl_compliance>false</wsdl_compliance>
    </sys_web_service>
</record_update>
